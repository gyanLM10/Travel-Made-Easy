import streamlit as st
import datetime


def get_travel_plan_validated(question: str) -> dict:
    """Run the planner + critic. Returns {plan, validation}."""
    try:
        from travel_agent import get_travel_plan_with_validation
        return get_travel_plan_with_validation(question)
    except Exception as exc:
        return {
            "plan": (
                "Error: Unable to initialize the travel planner backend. "
                f"Details: {exc}"
            ),
            "validation": {
                "confidence_score": -1,
                "trustworthy": True,
                "uncertain_claims": [],
                "verified_by_tools": [],
                "summary": "Trustworthiness check unavailable.",
            },
        }


def transcribe_audio(uploaded_file) -> str:
    from utils.speech_to_text import transcribe_audio as run_transcription
    return run_transcription(uploaded_file)


def render_plan(question: str, result: dict, source_label: str = "") -> None:
    """Renders the plan text and the trustworthiness panel."""
    plan = result.get("plan", "")
    validation = result.get("validation", {})
    score = validation.get("confidence_score", -1)
    uncertain = validation.get("uncertain_claims", [])
    verified = validation.get("verified_by_tools", [])
    summary = validation.get("summary", "")

    title = f"ğŸŒ AI Travel Plan{f' ({source_label})' if source_label else ''}"
    st.markdown(
        f"""
# {title}

**Generated:** {datetime.datetime.now().strftime('%Y-%m-%d at %H:%M')}  
**Created by:** Gyan's Travel Agent

---

{plan}

---

*This travel plan was generated by AI. Please verify prices, timings, and travel requirements before booking.*
"""
    )

    # â”€â”€ Trustworthiness Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.divider()
    st.subheader("ğŸ” Trustworthiness Report")

    if score == -1:
        st.info("â„¹ï¸ Confidence check was unavailable for this response.")
    else:
        # Colour-coded badge
        if score >= 80:
            badge = f"ğŸŸ¢ **High Confidence â€” {score}/100**"
            st.success(badge)
        elif score >= 50:
            badge = f"ğŸŸ¡ **Verify Before Booking â€” {score}/100**"
            st.warning(badge)
        else:
            badge = f"ğŸ”´ **Low Confidence â€” {score}/100**"
            st.error(badge)

        if summary:
            st.caption(f"_Critic's verdict: {summary}_")

        col1, col2 = st.columns(2)

        with col1:
            if uncertain:
                with st.expander(f"âš ï¸ {len(uncertain)} claim(s) to verify", expanded=score < 60):
                    for claim in uncertain:
                        st.markdown(f"- {claim}")
            else:
                st.success("âœ… No specific unverifiable claims flagged.")

        with col2:
            if verified:
                with st.expander("âœ… Grounded by tools", expanded=False):
                    for tool in verified:
                        st.markdown(f"- {tool.capitalize()}")
            else:
                st.caption("No live-tool grounding detected.")
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


st.set_page_config(
    page_title="ğŸŒ Travel Made Easy",
    page_icon="ğŸŒ",
    layout="centered",
    initial_sidebar_state="expanded",
)

st.title("ğŸŒ Travel Made Easy")

st.header("How can I help you in planning a trip?")

# -----------------------------
# TEXT INPUT
# -----------------------------
st.subheader("âŒ¨ï¸ Type your travel request")

with st.form(key="query_form", clear_on_submit=True):
    user_input = st.text_input(
        "User Input",
        placeholder="e.g. 5-day trip to Paris with budget breakdown"
    )
    submit_button = st.form_submit_button("Send")

# -----------------------------
# VOICE INPUT
# -----------------------------
st.subheader("ğŸ™ï¸ Or speak your travel request")

audio_file = st.file_uploader(
    "Upload an audio file (wav / mp3 / m4a)",
    type=["wav", "mp3", "m4a"]
)

# -----------------------------
# HANDLE TEXT QUERY
# -----------------------------
if submit_button and user_input.strip():
    with st.spinner("ğŸ¤– Planning your trip..."):
        result = get_travel_plan_validated(user_input)
    with st.spinner("ğŸ” Running trustworthiness check..."):
        pass  # validation already done inside get_travel_plan_validated
    render_plan(user_input, result)

# -----------------------------
# HANDLE VOICE QUERY
# -----------------------------
if audio_file is not None:
    try:
        with st.spinner("ğŸ§ Transcribing audio..."):
            spoken_text = transcribe_audio(audio_file)
    except Exception as exc:
        st.error(
            "Voice transcription is currently unavailable. "
            f"Details: {exc}"
        )
        st.stop()

    st.success(f"ğŸ—£ï¸ You said: **{spoken_text}**")

    with st.spinner("ğŸ¤– Planning your trip..."):
        result = get_travel_plan_validated(spoken_text)

    render_plan(spoken_text, result, source_label="Voice Input")
